name: Auto-Sign Commits

# This workflow automatically signs commits from GitHub Actions/bots
# It triggers on pushes to any branch except main

on:
  push:
    branches:
      - '**'
      - '!main'

permissions:
  contents: write

jobs:
  check-and-sign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug workflow context
        run: |
          echo "üîç Workflow triggered by: ${{ github.actor }}"
          echo "üìù Last commit author: $(git log -1 --pretty=format:'%an <%ae>')"
          echo "üìù Last commit committer: $(git log -1 --pretty=format:'%cn <%ce>')"
          echo "üìù Commit SHA: $(git log -1 --pretty=format:'%H')"
          echo "üìù Commit message: $(git log -1 --pretty=format:'%s')"

      - name: Check if commit is from a bot
        id: bot_check
        run: |
          # Get commit author and committer emails
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          COMMITTER_EMAIL=$(git log -1 --pretty=format:'%ce')

          # Check if commit is from a bot (includes Copilot, GitHub Actions, etc.)
          if echo "$AUTHOR_EMAIL" | grep -qE '(bot|noreply\.github\.com|copilot)'; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Detected bot commit from: $AUTHOR_EMAIL"
          elif echo "$COMMITTER_EMAIL" | grep -qE '(bot|noreply\.github\.com|copilot)'; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Detected bot commit from committer: $COMMITTER_EMAIL"
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Not a bot commit (author: $AUTHOR_EMAIL, committer: $COMMITTER_EMAIL)"
          fi

      - name: Check if GPG key is configured
        id: gpg_check
        run: |
          if [ -n "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not a bot commit
        if: steps.bot_check.outputs.is_bot == 'false'
        run: |
          echo "‚ÑπÔ∏è This is not a bot commit, skipping auto-signing."
          echo "‚ÑπÔ∏è Auto-signing only applies to commits from bots and automated tools."
          exit 0

      - name: Import GPG key
        if: |
          steps.bot_check.outputs.is_bot == 'true' &&
          steps.gpg_check.outputs.configured == 'true'
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
          git_tag_gpgsign: true

      - name: Check last commit signature
        id: check_signature
        run: |
          # Check if the last commit is signed
          if git verify-commit HEAD 2>/dev/null; then
            echo "signed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Last commit is already signed"
          else
            echo "signed=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Last commit is not signed"
          fi

      - name: Sign last commit
        if: |
          steps.bot_check.outputs.is_bot == 'true' &&
          steps.gpg_check.outputs.configured == 'true' &&
          steps.check_signature.outputs.signed == 'false'
        run: |
          # Amend the last commit with a signature
          git commit --amend --no-edit -S

          echo "‚úÖ Signed commit: $(git log -1 --pretty=format:'%h - %s')"

      - name: Push signed commit
        if: |
          steps.bot_check.outputs.is_bot == 'true' &&
          steps.gpg_check.outputs.configured == 'true' &&
          steps.check_signature.outputs.signed == 'false'
        run: |
          git push --force-with-lease
          echo "‚úÖ Pushed signed commit to ${{ github.ref }}"

      - name: Warning if no GPG key
        if: |
          steps.bot_check.outputs.is_bot == 'true' &&
          steps.gpg_check.outputs.configured == 'false' &&
          steps.check_signature.outputs.signed == 'false'
        run: |
          echo "::warning::No GPG key configured. Commits from bots are unsigned."
          echo "::warning::Add GPG_PRIVATE_KEY to repository secrets."
          echo "::warning::See GPG_SIGNING.md for instructions."
